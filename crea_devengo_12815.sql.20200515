CREATE OR REPLACE FUNCTION public.crea_devengo_12815(character varying)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
declare
        xml1    alias for $1;
        xml2    varchar;
        v_rut_emisor_devengo varchar;
        v_uri   varchar;
        v_rut_receptor_devengo varchar;
        v_cod_oc varchar;
        v_cod_rc varchar;
        v_monto_devengo varchar;
        v_periodo varchar;
        v_ejercicio varchar;
        v_tipo_dte varchar;
        v_codigo_devengo bigint;
        v_area_tx       varchar;
        v_folio_compromiso      varchar;
        tipo_devengo    varchar;
        v_json_devengo_sigfe    json;
        v_titulo_devengo       varchar;
        v_descripcion_devengo  varchar;
        v_folio_dte            varchar;
        v_contabiliza_iva      boolean;
        v_tipo_devengo         varchar;
        v_area_trx_oc          varchar;
        v_area_trx_dte         varchar;
        v_num_area_trx         integer;
        v_forma_pago           varchar;  -- FGE - 20190814 - Marcador de Forma de Pago
        json2           json;
        codigo_txel1    bigint;
        v_razon_social_receptor  varchar;
	v_codigo_txel          varchar;
	v_reg_oc                     record;
	v_reg_cliente                record;
	v_reg_indexer_hash_recibido  record;
	v_num_area	integer;	
begin
        xml2:=xml1;
        xml2:=put_campo(xml2,'__SECUENCIAOK__','0');


        --Se crea el registro en dp_devengo con los datos que se tienen.
        v_rut_emisor_devengo:=get_campo('RUT_RECEPTOR',xml2);
        v_uri:=get_campo('URI_IN',xml2);
        v_rut_receptor_devengo:=get_campo('RUT_EMISOR',xml2);
        v_cod_oc:=get_campo('DP_COD_OC',xml2);
        v_folio_compromiso:=get_campo('DP_FOLIO_COMPROMISO',xml2);
        v_area_tx:=get_campo('DP_AREA_TX',xml2);
        v_cod_rc:=get_campo('DP_COD_RC',xml2);
        v_monto_devengo:=get_campo('MONTO_TOTAL',xml2);
        v_periodo:=split_part(get_campo('FECHA_EMISION',xml2),'-',2);
        v_ejercicio:=split_part(get_campo('FECHA_EMISION',xml2),'-',1);
        v_tipo_dte:=get_campo('TIPO_DTE',xml2);
        v_folio_dte:=get_campo('FOLIO', xml2);
	--Se validan datos para saber si es devengo manual o Aut.
        -- FGE - 20191016 - Tambien verifico que v_area_tx pueda incluir solamente el area transaccional
        --if v_area_tx = '' or v_folio_compromiso='' then
        tipo_devengo:='AUT';
        v_codigo_txel = coalesce(nullif(get_campo('CODIGO_TXEL', xml2), ''), '0');

        if v_area_tx = '' or length(trim(v_area_tx)) = 3 then
                if v_cod_oc <> '' then
                        select area_transaccional from de_emitidos where rut_emisor = v_rut_emisor_devengo::integer and folio = v_cod_oc and coalesce(folio_compromiso, '') <> ''  into v_reg_oc;
                        if found then
                                v_area_tx:=v_reg_oc.area_transaccional;
                                update dte_recibidos set parametro1 = substring(v_area_tx, 5, 3) where codigo_txel = v_codigo_txel::bigint;
                        end if;
                end if;
                select gob_partida_capitulo from maestro_clientes where rut_emisor = v_rut_emisor_devengo::integer into v_reg_cliente;
                if length(trim(v_area_tx)) = 3 then
                        -- FGE - 20191016 - Primero verifico que el area asignada sea un area que existe.
                        select codigo from indexer_hash_recibidos where rut_emisor = v_rut_emisor_devengo::integer and estado = 'HABILITADA' and codigo = trim(v_area_tx) into v_reg_indexer_hash_recibido;
                        if found then
                                v_area_tx:=v_reg_cliente.gob_partida_capitulo || trim(v_area_tx);
                                update dte_recibidos set parametro1 = substring(v_area_tx, 5, 3) where codigo_txel = v_codigo_txel::bigint;
                        else
                                v_area_tx:='';
                        end if;
                end if;
                if v_area_tx = '' then
                        select count(1) into v_num_area from indexer_hash_recibidos where rut_emisor = v_rut_emisor_devengo::integer and estado = 'HABILITADA' and codigo <> 'SIN_DATO';
                        if v_num_area = 1 then
                                select codigo from indexer_hash_recibidos where rut_emisor = v_rut_emisor_devengo::integer and estado = 'HABILITADA' and codigo <> 'SIN_DATO' into v_reg_indexer_hash_recibido;
                                v_area_tx:=v_reg_cliente.gob_partida_capitulo || v_reg_indexer_hash_recibido.codigo::varchar;
                                update dte_recibidos set parametro1 = substring(v_area_tx, 5, 3) where codigo_txel = v_codigo_txel::bigint;
                        end if;
                end if;
        end if;

        if v_folio_compromiso='' then
                -- TODO: buscar OC y luego verificar el folio compromiso
                if v_cod_oc <> '' then
                        select folio_compromiso from de_emitidos where (rut_emisor = v_rut_emisor_devengo::integer or rut_emisor = 61608700) and folio = v_cod_oc and coalesce(folio_compromiso, '') <> ''  into v_reg_oc;
                        if found then
                                v_folio_compromiso:=v_reg_oc.folio_compromiso;
                        else
                                tipo_devengo:='MAN';
                        end if;
                else
                        tipo_devengo:='MAN';
                end if;
        end if;

        --Se validan datos para saber si es devengo manual o Aut.
        if v_area_tx = '' or v_folio_compromiso='' then
                tipo_devengo :='MAN';
        else
                tipo_devengo :='AUT';
        end if;

        --Razon social del receptor del devengo para el titulo
        select nombre into v_razon_social_receptor from contribuyentes where rut_emisor = v_rut_receptor_devengo::integer;
        if not found then
                v_razon_social_receptor:='';
        end if;

        --Validamos si existe Devengo para esta URL
        select codigo_dv into v_codigo_devengo from dp_devengo where uri_dte=v_uri;
        if not found then
                v_titulo_devengo:= case when (v_tipo_dte::integer = 33) then 'FA' when (v_tipo_dte::integer = 34) then 'FE' when (v_tipo_dte::integer = 56) then 'ND' when (v_tipo_dte::integer = 61) then 'NC' end;
                v_titulo_devengo:= v_titulo_devengo || ' / ' || v_folio_dte || ' / ' || v_rut_receptor_devengo || ' / ' || v_cod_oc || ' / ' || v_razon_social_receptor;

                select gob_contabiliza_iva into v_contabiliza_iva from maestro_clientes where rut_emisor = v_rut_emisor_devengo::integer;
                if found then
                        if v_contabiliza_iva = true and v_tipo_dte in ('33', '43') then
                                tipo_devengo:='MAN';
                        end if;
                end if;

                xml2:=logapp(xml2,'Inserto dp_devengo uri='||v_uri||' codigo_txel='||get_campo('CODIGO_TXEL',xml2));
                codigo_txel1:=get_campo('CODIGO_TXEL',xml2)::bigint;

                select parametro1, get_xml('FmaPago', data_dte) into v_area_trx_dte, v_forma_pago from dte_recibidos where codigo_txel = codigo_txel1;
                if found then
                        if v_cod_oc <> '' and coalesce(v_area_trx_dte, '') in ('', 'SIN_DATO') then
                                select coalesce(area_transaccional, '') into v_area_trx_oc from de_emitidos where folio = v_cod_oc and rut_emisor = v_rut_emisor_devengo::integer and rut_receptor = v_rut_receptor_devengo::integer and origen = 'MP';
                                if found and v_area_trx_oc <> '' then
                                        xml2:=logapp(xml2, 'Asigno areaTrx ' || v_area_trx_oc || ' de OC ' || v_cod_oc || ' a DTE ' || codigo_txel1::varchar);
                                        update dte_recibidos set parametro1 = substring(v_area_trx_oc, 5, 3) where codigo_txel=codigo_txel1;
                                end if;
                        else
                                select count(1) into v_num_area_trx from indexer_hash_recibidos where rut_emisor = v_rut_emisor_devengo::integer;
                                if v_num_area_trx = 1 then
                                        select codigo into v_area_trx_dte from indexer_hash_recibidos where rut_emisor = v_rut_emisor_devengo::integer;
                                        xml2:=logapp(xml2, 'Asigno areaTrx ' || v_area_trx_dte || ' de indexer_hash_recibidos a DTE ' || codigo_txel1::varchar);
                                        update dte_recibidos set parametro1 = v_area_trx_dte where codigo_txel=codigo_txel1;
                                end if;
                        end if;
                end if;

                -- FGE - 20190814 - Incluyo el marcador de pago de contado
                if v_forma_pago <> '1' then
                    v_forma_pago := '2';
                end if;

                update dte_recibidos set data_dte = put_data_dte(data_dte, 'CODIGO_RC', v_cod_rc::varchar) where codigo_txel=codigo_txel1;
                insert into dp_devengo (codigo_dv,  uri_dte, rut_receptor, rut_emisor,  folio_requerimiento, fecha_creacion, estado, codigo_oc, codigo_rc,  monto_devengo, cod_moneda, periodo, ejercicio,area_transaccional, anticipo, tipo_devengo, tipo_dte, titulo, descripcion,dte_codigo_txel, forma_pago) values (default, v_uri,v_rut_receptor_devengo::integer, v_rut_emisor_devengo::integer, v_folio_compromiso,now(),'BORRADOR',v_cod_oc,v_cod_rc,v_monto_devengo::bigint, 'CLP',v_periodo::integer, v_ejercicio::integer,v_area_tx, 'N',tipo_devengo , v_tipo_dte::integer, substring(v_titulo_devengo, 1, 79), substring(v_titulo_devengo, 1, 249),get_campo('CODIGO_TXEL',xml2), v_forma_pago::integer) returning codigo_dv into v_codigo_devengo ;
                perform dp_act_estado_devengo(v_codigo_devengo::bigint, 'BORRADOR', '');
                if not found then
                        xml2:=logapp(xml2,'Error al graba dp_devengo');
                        xml2:=put_campo(xml2,'__SECUENCIAOK__','1000');
                        return xml2;
                end if;
        else
                xml2:=logapp(xml2,'Aplica Proxy v_codigo_devengo '||v_uri);
        end if;


        xml2:=logapp(xml2,'Datos UPDATE' || v_rut_emisor_devengo ||' ' || v_rut_receptor_devengo||' ' || v_tipo_dte ||' ' ||v_cod_oc ||' ' || v_cod_rc );
        --Se marca la RecepciÃ³n conforme en estado EN_CURSO.
        --update token_de_emitidos set estado='EN_CURSO' where rut_emisor=v_rut_emisor_devengo::integer and rut_receptor=v_rut_receptor_devengo::integer and folio=v_cod_oc and token=v_cod_rc;
	-- FGE - 20191118 - Prevenimos la llamada al 12813 con el siguiente IF.
        if v_area_tx = '' then
               tipo_devengo = 'MAN';
        end if;
	update token_de_emitidos set estado='EN_CURSO', codigo_dv = v_codigo_devengo::bigint where rut_emisor=v_rut_emisor_devengo::integer and rut_receptor=v_rut_receptor_devengo::integer and folio=v_cod_oc and token=v_cod_rc;
	
        if (tipo_devengo ='MAN') then
                codigo_txel1:=get_campo('CODIGO_TXEL',xml2)::bigint;
                update dte_recibidos set data_dte = put_data_dte(data_dte, 'TIPO_DEVENGO', 'MAN') where codigo_txel = codigo_txel1;
                xml2:=logapp(xml2,'Devengo Manual, no sigue con los MS Area Tx -> ' || v_area_tx || ' Folio Comp-->' || v_folio_compromiso);
                xml2:=put_campo(xml2,'__SECUENCIAOK__','1000');
                return xml2;
        end if;



        --Se prepara la llamada al servicio de Sigfe

        --datos
        v_json_devengo_sigfe:='{}'::json;
        v_json_devengo_sigfe:=put_json(v_json_devengo_sigfe,'partida', substring(v_area_tx, 1, 2));
        v_json_devengo_sigfe:=put_json(v_json_devengo_sigfe,'capitulo', substring(v_area_tx, 3, 2));
        v_json_devengo_sigfe:=put_json(v_json_devengo_sigfe,'areaTransaccional', substring(v_area_tx, 5, 3));
        v_json_devengo_sigfe:=put_json(v_json_devengo_sigfe,'ejercicio', v_ejercicio);
        v_json_devengo_sigfe:=put_json(v_json_devengo_sigfe,'folio',v_folio_compromiso);

        --xml2:='{}'::json;
        xml2:=put_campo(xml2,'codigo_dv',v_codigo_devengo::varchar);
        xml2:=get_parametros_motor(xml2,'OBTIENECOMPROMISOS_CHC');
	xml2:=put_campo(xml2,'__TIMEOUT_SERV_PXML__','60');
        xml2:=put_campo(xml2,'HOST_MS',get_campo('__IP_CONEXION_CLIENTE__',xml2));
        xml2:=put_campo(xml2,'URI_MS',get_campo('PARAMETRO_RUTA',xml2));
        xml2:=put_campo(xml2,'DATA_JSON',encode_hex(v_json_devengo_sigfe::varchar));
        xml2:=put_campo(xml2,'LARGO_JSON',(length(encode_hex(v_json_devengo_sigfe::varchar))/2)::varchar);

	xml2:=logapp(xml2,'OBTIENECOMPROMISOS_CHC ='||v_json_devengo_sigfe::varchar);
        xml2:=put_campo(xml2,'__SECUENCIAOK__','20');
        return xml2;
end;
$function$
